{
    "collab_server" : "",
    "contents" : "## Facebook Ad API Scraper #####\n## By Vivek Menon ##############\n\n# Setup -------------------------------------------------\n\n#.Options - Check current factory options.\n#options(stringsAsFactors = FALSE)\n\nlibrary(httr)\nlibrary(RJSONIO)\nlibrary(RCurl)\nlibrary(devtools)\nlibrary(xlsx)\n\n# RFacebook - Dev\n#install_github(\"pablobarbera/Rfacebook/Rfacebook\")\n#library(Rfacebook)\n\n# RFacebook - Stable\n#install.packages(\"Rfacebook\")\n#library(Rfacebook)\n\n\n# Todo --------------------------------------------------\n# - bug fixes, date_preset for v2.7 set to 30 by default, reset to lifetime\n# - set to more rigorous method to pull ads at adaccount_id level, for batch processing\n\n\n# Functions ---------------------------------------------------------------\n\n# User Functions\n# Function to convert Facebook date format to R date format\nformat.facebook.date <- function(datestring) {\n  date <- as.POSIXct(datestring, format = \"%Y-%m-%dT%H:%M:%S+0000\", tz = \"GMT\")\n}\n\n\n# Inputs ------------------------------------------------\n# Turn stringsAsFactors off so rbind works properly.\noptions(stringsAsFactors = FALSE)\n\n# Find OAuth settings for facebook:\n#http://developers.facebook.com/docs/authentication/server-side/\nfacebook <- oauth_endpoints(\"facebook\")\n\n# Set OAUTH Settings\napp_name <- \"r_access\"\napp_id <- \"955460364539237\"\napp_secret <- \"0a3e6943c90510dc158fc7683e560f7d\"\nscope = \"ads_management,manage_pages,publish_actions\"\n\n# Get a callback URL that matches the value entered in the Facebook App, typically \"https://localhost:1410\"\nfull_url <- oauth_callback()\nfull_url <- gsub(\"(.*localhost:[0-9]{1,5}/).*\", x=full_url, replacement=\"\\\\1\")\nmessage <- paste(\"Copy and paste into Site URL on Facebook App Settings:\",\nfull_url, \"\\nWhen done, press any key to continue...\")\n\n# Reminder to add callback into the app page.\ninvisible(readline(message))\n\n# Intialize App\nmyapp <- oauth_app(app_name, app_id, app_secret)\n\n# Current httr version, to test oauth protocol. [Required to set global port variables; won't work otherwise.]\nif (packageVersion('httr') > \"0.6.1\"){\n  Sys.setenv(\"HTTR_SERVER_PORT\" = \"1410/\")\n  fb_oauth <- oauth2.0_token(facebook, myapp,\n scope=scope, type = \"application/x-www-form-urlencoded\", cache=FALSE)\n  if (GET(\"https://graph.facebook.com/me\", config(token=fb_oauth))$status==200){\nmessage(\"Authentication successful.\")\n  }\n}\n\n\n\n# Tests -------------------------------------------------------------------\n\n\n# Test 1: Facebook Profile Information\nreq <- GET(\"https://graph.facebook.com/v2.7/me?fields=id,name\", config(token = fb_oauth))\nstop_for_status(req)\nstr(content(req))\n\n# Test 2: Ad Account Information\naccountreq <- GET(\"https://graph.facebook.com/v2.7/act_10152197009270686?fields=name\", config(token = fb_oauth))\n\nadaccountname <- content(accountreq)[1]$name\nadaccountid <- content(accountreq)[2]$id\n\n# Inputs ------------------------------------------------------------------\n\n## Nodes:\n# /insights is new /stats; gets ad data at the account and id level\n# /keywordstats = interests in ad manager UI\n\n## Variables\n# Number of Ads to Pull\nads = 2000 #So far, only 200 in the account.\n\n## Parameters:\n#[1] All valid values are: date_start, date_stop, account_id, account_name, adgroup_id, adgroup_name, campaign_group_id, campaign_group_name, campaign_id, campaign_name, action_carousel_card_id, action_carousel_card_name, actions, unique_actions, total_actions, total_unique_actions, action_values, total_action_value, impressions, social_impressions, clicks, social_clicks, unique_impressions, unique_social_impressions, unique_clicks, unique_social_clicks, spend, frequency, social_spend, deeplink_clicks, app_store_clicks, website_clicks, call_to_action_clicks, newsfeed_avg_position, newsfeed_impressions, newsfeed_clicks, reach, social_reach, ctr, unique_ctr, cpc, cpm, cpp, cost_per_total_action, cost_per_action_type, cost_per_unique_click, cost_per_10_sec_video_view, relevance_score, website_ctr, video_avg_sec_watched_actions, video_avg_pct_watched_actions, video_p25_watched_actions, video_p50_watched_actions, video_p75_watched_actions, video_p95_watched_actions, video_p100_watched_actions, video_complete_watched_actions, video_10_sec_watched_actions, video_15_sec_watched_actions, video_30_sec_watched_actions\"\n\n# Processing --------------------------------------------------------------\n\n### Intial Batch Ad Pull\n# Dataframe and Query Result holder\n\ninitialcontent <- NULL\nafter <- NULL\n\n# Pull all ad ids and names, batch mode, intialize at error for try/except\ninitialreq$status_code <- 400\ncount <- 0\n\n# Try/Except for first batch\ninitialreq <- tryCatch({\nGET(paste0(\"https://graph.facebook.com/v2.7/act_693722000711682/campaigns?fields=name,objective,id,created_time&limit=\",ads), config(token = fb_oauth))\n  })\n\n# Look into Packet\nstr(content(initialreq))\ninitialcontent <- content(initialreq)\n\n# List of 200; don't need to paginate yet\nafter <- initialcontent$paging$cursors$after\n\n\n## Loop 1, Organize all ads into dataset\nprint(paste(\"Pulling All Ad Campaigns for\",paste0(adaccountname,\".\")))\n\nadlist <- data.frame(NULL, stringsAsFactors = FALSE)\nad <- 0\n\n\n\n# Query -------------------------------------------------------------------\n\n# Populate\nfor (ad in (1:(length(initialcontent$data)))) {\n    #print(i)\n\n    adlist[ad,c(\"ad.campaign.id\")] <- initialcontent$data[[ad]]$id\n    adlist[ad,c(\"ad.campaign.name\")] <- initialcontent$data[[ad]]$name\n    adlist[ad,c(\"objective\")] <- initialcontent$data[[ad]]$objective\n    #adlist[ad,c(\"status\")] <- initialcontent$data[[ad]]$campaign_group_status\n    adlist[ad,c(\"created.time\")] <- substr(initialcontent$data[[ad]]$created_time, 1, 10)\n\n\n    #adlist[ad,c(\"campaign id\")] <- initialcontent$data[[ad]]$campaign_id\n    #adlist[ad,c(\"campaign name\")] <- initialcontent$data[[ad]]$campaign_name\n    # Use this loop to populate with admetrics, and augment initial dataset; will not affect following loops.\n\n    completion <- (ad/(length(initialcontent$data))*100)\n\n    print(paste(paste0(round(completion, digits = 0),\"%\"), \"Complete.\"))\n  }\n\n\nadlist_store <- adlist\n\n# Metrics wanted\nadmetrics <- c(\"frequency,newsfeed_avg_position,ctr,unique_ctr,spend,reach,social_reach,unique_clicks,social_clicks,cost_per_unique_click,total_actions,cost_per_total_action,actions,video_avg_pct_watched_actions,video_avg_sec_watched_actions\") #\"cost_per_action_type\"\n\n# Metrics framed\noveralladmetricsreturned <- c(\"date_start\",\"date_stop\",\"spend\",\"reach\",\"social_reach\",\"frequency\",\"page_engagement\",\"post_engagement\",\"unique_clicks\",\"social_clicks\",\"cost_per_unique_click\",\"total_actions\",\"cost_per_total_action\",\"like\",\"post_like\",\"comment\",\"share\",\"link_click\",\"photo_view\",\"video_play\",\"video_view\",\"video_avg_sec_watched_video_view\",\"video_avg_sec_watched_page_engagement\",\"video_avg_sec_watched_post_engagement\",\"video_avg_pct_watched_video_view\",\"video_avg_pct_watched_page_engagement\",\"video_avg_pct_watched_post_engagement\")\n\n\n# Subset adlist if necessary\n#adlist <- subset(adlist, created.time > \"2016-04-26\")\n#adlist <- subset(adlist, \"2016-07-05\" > created.time)\n\n# Setup data.frame for ad data\nadoveralldata <- data.frame(stringsAsFactors = FALSE)\n\n# Look for a single client; i.e. BAR\nadlist <- adlist[grep(\"BAR\",adlist$ad.campaign.name),]\n\n# Warning: Massive while loop that continues until the ad list is retrieved from Facebook.\n# May Need to restart/interrupt R to stop the loop.\n# Also stops working with each API update; review doc changes\n\nfor (ad in 1:nrow(adlist)) {\n  print(paste0('Querying Ad ',ad,\": \", adlist$ad.campaign.name[ad]))\n  adreq$status_code = 400\n  count <- 0\n\n  try(adreq <- GET(paste0(\"https://graph.facebook.com/v2.7/\",adlist[ad,1],\"/insights?fields=\",paste(admetrics[1],collapse=\",\"),\"&date_preset=lifetime&time_increment=1\"), config(token = fb_oauth)))\n\n  if(adreq$status_code == 400) {\n    while(adreq$status_code == 400) {\n      try(adreq <- GET(paste0(\"https://graph.facebook.com/v2.7/\",adlist[ad,1],\"/insights?fields=\",paste(admetrics[1],collapse=\",\"),\"&date_preset=lifetime&time_increment=1\"), config(token = fb_oauth)))\n\n      count <- count + 1\n      print(adreq)\n      print(paste('Limit Reached. Waiting 30 seconds.'))\n      print(paste('Attempt:',count))\n      Sys.sleep(30) #5*60\n    }\n  } else {\n    print('Query successful.')\n  }\n\n  # Organize/clean data\n  adcontent <- content(adreq)\n  adcontentparsed <- unlist(adcontent$data, use.names=TRUE, recursive=TRUE)\n\n  print(adcontentparsed)\n\n  nextpage <- adcontent$paging$`next`\n\n  while (is.null(nextpage) == FALSE) {\n    #print(\"Additional Days\")\n\n    adreq.additional <- GET(adcontent$paging$`next`, config(token = fb_oauth))\n    adcontent.additional <- content(adreq.additional)\n    adcontent.additional.parsed <- unlist(adcontent.additional, use.names=TRUE, recursive=TRUE)\n\n    adcontentparsed <- c(adcontentparsed,adcontent.additional.parsed)\n    nextpage <- adcontent.additional$paging$`next`\n  }\n\n  adcontentparsed.store <- adcontentparsed\n\n  # TODO: Squish a Bug right here. Fix for the full Baron report later on.\n  names(adcontentparsed)[(names(adcontentparsed) == (\"actions.value\"))] <- adcontentparsed[(names(adcontentparsed) == (\"actions.action_type\"))]\n  adcontentparsed <- adcontentparsed[-which((names(adcontentparsed) == (\"actions.action_type\")))]\n\n  if (length(which(names(adcontentparsed) %in% c(\"video_avg_pct_watched_actions.action_type\",\"video_avg_sec_watched_actions.action_type\"))) > 1) {\n    names(adcontentparsed)[(names(adcontentparsed) == (\"video_avg_sec_watched_actions.value\"))] <- paste0(\"video_avg_sec_watched_\",adcontentparsed[(names(adcontentparsed) == (\"video_avg_sec_watched_actions.action_type\"))])\n    names(adcontentparsed)[(names(adcontentparsed) == (\"video_avg_pct_watched_actions.value\"))] <- paste0(\"video_avg_pct_watched_\",adcontentparsed[(names(adcontentparsed) == (\"video_avg_sec_watched_actions.action_type\"))])\n\n    adcontentparsed <- adcontentparsed[-which((names(adcontentparsed) == (\"video_avg_pct_watched_actions.action_type\")))]\n  }\n\n  # Frame data for inclusion\n\n  days = length((adcontentparsed[overalladmetricsreturned[1] == names(adcontentparsed)]))\n\n  header <- c(adlist[ad,c(\"ad.campaign.id\",\"ad.campaign.name\",\"objective\",\"created.time\")])\n  footer <- data.frame()\n\n  if (is.null(adcontentparsed)==TRUE) {\n    footer <- rep(0,length(overalladmetricsreturned))\n    names(footer) <- overalladmetricsreturned\n    adoverallset <- c(unlist(header),footer)\n  } else {\n    for (day in 1:days) {\n      for (metric in 1:length(overalladmetricsreturned)) {\n\n        if (is.na(adcontentparsed[(overalladmetricsreturned[metric] == names(adcontentparsed))][day]) == TRUE) {\n          footer[day,metric] <- 0\n        } else {\n          footer[day,metric] <- adcontentparsed[(overalladmetricsreturned[metric] == names(adcontentparsed))][day]\n        }\n      }\n    }\n    colnames(footer) <- overalladmetricsreturned\n    adoverallset <- cbind(header,footer)\n  }\n\n\n  adoveralldata <- rbind(adoveralldata,adoverallset)\n\n  colnames(adoveralldata) <- c(names(header),overalladmetricsreturned)\n\n  # Print processing stats\n  # print(ad)\n  # print(nrow(adoveralldata))\n  # print(paste0(\"Finding Facebook Data for Ad Set \",ad,\": \",adlist[ad,2]))\n  print(paste0('Primary dataset appended: ',nrow(adoveralldata),' rows retrieved from Facebook.'))\n  # print(paste(paste0(round(completion, digits = 0),\"%\"), \"of Ads Processed.\"))\n\n}\n\n\n# Quick renaming if necssary\n#names(adoveralldata) <- overalladmetricsreturned\nprint(adoveralldata)\n\n# Exporting ---------------------------------------------------------------\n\nadoveralldatastore <- adoveralldata\n#adoveralldata <- adoveralldatastore\n\nadoveralldata[is.na(adoveralldata)] <- \"\"\n#adoveralldata[,-c(2:6)] <- sapply(adoveralldata[,-c(2:6)], as.numeric)\n\n#pagedata[,-c(1:3)] <- sapply(pagedata[,-c(1:3)], as.numeric)\n#postdata[,-c(1:10)] <- sapply(postdata[,-c(1:10)], as.numeric)\n\n# Directory location\nsetwd(\"/Users/vivek.menon\")\ndatafolder <- \"Data\"\n\n# Generate map\ndir.create(file.path(getwd(), datafolder), showWarnings = FALSE)\n\n# Return an XLS (Deprecated)\nwrite.xlsx(adoveralldata, paste0(getwd(),\"/\",datafolder,\"/\",paste(adaccountname,\"Ad Data\",Sys.Date(), sep=\" \"),\".xlsx\"), row.names=FALSE, showNA=FALSE)\n\n# Return a CSV\nwrite.csv(adoveralldata, file = paste0(getwd(),\"/\",datafolder,\"/\",paste(adaccountname,\"Ad Data\",Sys.Date(), sep=\" \"),\".csv\"), row.names=FALSE)\n",
    "created" : 1439929273249.000,
    "dirty" : false,
    "encoding" : "",
    "folds" : "",
    "hash" : "666431414",
    "id" : "93B9094E",
    "lastKnownWriteTime" : 1490382733,
    "last_content_update" : 1490382733168,
    "path" : "~/Desktop/FacebookADQuery.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}